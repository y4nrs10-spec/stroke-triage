<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stroke Triage (Web)</title>
  <style>
    :root{
      --bg:#071326; --card:#0e1f3b; --card2:#0b1a33;
      --text:#e8eefc; --muted:#a9b7d6; --line:rgba(255,255,255,.10);
      --accent:#18a7ff; --danger:#ff5d5d; --ok:#36d399; --warn:#fbbf24;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background:radial-gradient(1200px 700px at 30% -10%, #12346a 0%, rgba(18,52,106,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 60px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:20px;margin:0;font-weight:800;letter-spacing:.3px}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
      margin:14px 0;
    }
    .card h2{margin:0 0 12px;font-size:18px}
    .grid{display:grid;gap:10px}
    .grid.cols2{grid-template-columns:1fr 1fr}
    .grid.cols3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid.cols2,.grid.cols3{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input,select,textarea{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.20); color:var(--text);
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .pillrow{display:flex;flex-direction:column;gap:8px}
    .pill{
      text-align:left; width:100%;
      border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:var(--text);
      padding:10px 12px; cursor:pointer;
    }
    .pill.on{border-color:rgba(24,167,255,.55); background:rgba(24,167,255,.14); color:#cfeaff}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      width:100%; padding:14px 14px; border-radius:14px; border:0;
      font-weight:800; cursor:pointer;
    }
    .btn.primary{background:linear-gradient(90deg,#00b2ff,#27c1ff); color:#00152a}
    .btn.ghost{background:rgba(255,255,255,.06); color:var(--text); border:1px solid var(--line)}
    .btn.danger{background:linear-gradient(90deg,#ff4d4d,#ff6b6b); color:#1a0000}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted);font-size:12px}
    .summaryBox{
      white-space:pre-wrap; border:1px solid var(--line); border-radius:14px;
      background:rgba(0,0,0,.18); padding:12px; min-height:110px;
      font-size:13px; line-height:1.5;
    }
    .histItem{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      border-top:1px solid var(--line); padding:12px 0;
    }
    .histItem:first-child{border-top:0;padding-top:0}
    .histMeta{font-size:12px;color:var(--muted);min-width:150px}
    .histText{font-size:13px;white-space:pre-wrap;flex:1}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      top:16px; background:rgba(0,0,0,.55); border:1px solid var(--line);
      padding:10px 14px; border-radius:999px; font-weight:700;
      opacity:0; pointer-events:none; transition:.18s;
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Stroke Triage (Web)</h1>
      <div class="badge" id="netBadge">通信: なし / 保存: 端末内</div>
    </header>

    <div class="card">
      <h2>基本情報</h2>
      <div class="grid cols2">
        <div>
          <label>患者ID</label>
          <input id="patientID" placeholder="例：123456" inputmode="numeric" />
        </div>
        <div>
          <label>年齢</label>
          <div class="row">
            <input id="age" placeholder="例：56" inputmode="numeric" />
            <select id="sex">
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:10px">
        <div>
          <label>最終健在（LKW）</label>
          <input id="lkw" type="datetime-local" />
        </div>
        <div>
          <label>発見・発症時刻</label>
          <input id="disc" type="datetime-local" />
        </div>
      </div>
      <div class="muted" style="margin-top:8px">経過: <span id="elapsed">—</span></div>

      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

      <h2 style="font-size:16px;margin-top:0">バイタル</h2>
      <div class="grid cols3">
        <div><label>JCS</label><input id="jcs" placeholder="—" /></div>
        <div><label>GCS E</label><input id="gcsE" placeholder="—" inputmode="numeric" /></div>
        <div><label>GCS V</label><input id="gcsV" placeholder="—" inputmode="numeric" /></div>
        <div><label>GCS M</label><input id="gcsM" placeholder="—" inputmode="numeric" /></div>
        <div><label>BP (収縮)</label><input id="bpSys" placeholder="—" inputmode="numeric" /></div>
        <div><label>BP (拡張)</label><input id="bpDia" placeholder="—" inputmode="numeric" /></div>
        <div><label>SpO₂ (%)</label><input id="spo2" placeholder="—" inputmode="numeric" /></div>
        <div><label>酸素 (L)</label><input id="oxygenFlow" placeholder="—" inputmode="decimal" /></div>
        <div><label>酸素 (%)</label><input id="oxygenPercent" placeholder="—" inputmode="numeric" /></div>
        <div><label>HR (/分)</label><input id="heartRate" placeholder="—" inputmode="numeric" /></div>
        <div>
          <label>リズム</label>
          <select id="heartRhythm">
            <option value="SR">SR</option>
            <option value="不整">不整</option>
          </select>
        </div>
        <div>
          <label>不整の種類</label>
          <select id="irregularSubtype">
            <option value="">未選択</option>
            <option value="Af">Af</option>
            <option value="PVC">PVC</option>
            <option value="PAC">PAC</option>
          </select>
        </div>
        <div><label>BS (mg/dl)</label><input id="bs" placeholder="—" inputmode="decimal" /></div>
        <div><label>BT (℃)</label><input id="bt" placeholder="—" inputmode="decimal" /></div>
        <div><label>瞳孔 右 (mm)</label><input id="pupilRight" placeholder="—" inputmode="decimal" /></div>
        <div><label>瞳孔 左 (mm)</label><input id="pupilLeft" placeholder="—" inputmode="decimal" /></div>
      </div>
    </div>

    <div class="card">
      <h2>既往歴</h2>
      <div class="seg" id="past"></div>
      <div style="margin-top:12px">
        <label>その他の既往歴（自由入力）</label>
        <textarea id="otherPast" placeholder="例：喘息、甲状腺疾患 など"></textarea>
      </div>
    </div>

    <div class="card">
      <h2>まとめ</h2>
      <div class="summaryBox" id="summary">ここに生成されます</div>
      <div class="grid cols2" style="margin-top:12px">
        <button class="btn primary" id="genBtn">まとめ生成</button>
        <button class="btn ghost" id="copyBtn">コピー</button>
      </div>
    </div>

    <div class="card">
      <h2>履歴</h2>
      <div id="historyList" class="muted">履歴はまだありません</div>
      <div style="margin-top:12px">
        <button class="btn danger" id="clearAllBtn">全削除</button>
      </div>
      <div class="muted" style="margin-top:8px">※最新10件を表示（端末内に保存）</div>
    </div>

    <div class="toast" id="toast">保存しました</div>
  </div>

<script>
  // -----------------------------
  // Storage Keys
  // -----------------------------
  const KEY_HISTORY = "summaryHistory_v1";
  const KEY_DRAFT = "draft_v1";

  // -----------------------------
  // Past history options
  // -----------------------------
  const pastOptions = ["高血圧","不整脈","心疾患","糖尿病","脂質異常症","脳梗塞","脳出血"];
  const pastSet = new Set();

  // -----------------------------
  // Helpers
  // -----------------------------
  const $ = (id)=>document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");

  function showToast(msg="保存しました"){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1100);
  }

  function parseDTLocal(v){
    if(!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  function formatMDHM(d){
    const M = d.getMonth()+1, D = d.getDate(), hh = pad2(d.getHours()), mm = pad2(d.getMinutes());
    return `${M}/${D} ${hh}:${mm}`;
  }

  function elapsedText(lkw, disc){
    if(!lkw || !disc) return "—";
    const min = Math.floor((disc.getTime() - lkw.getTime())/60000);
    const abs = Math.abs(min);
    const h = Math.floor(abs/60);
    const m = abs%60;
    const t = (h>0) ? `${h}時間${m}分` : `${m}分`;
    return (min<0) ? `⚠️ ${t}（発見が最終健在より前）` : t;
  }

  function loadHistory(){
    try{
      return JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
    }catch{ return []; }
  }
  function saveHistory(arr){
    localStorage.setItem(KEY_HISTORY, JSON.stringify(arr));
  }

  function loadDraft(){
    try{
      return JSON.parse(localStorage.getItem(KEY_DRAFT) || "{}");
    }catch{ return {}; }
  }
  function saveDraft(obj){
    localStorage.setItem(KEY_DRAFT, JSON.stringify(obj));
  }

  // -----------------------------
  // UI init
  // -----------------------------
  function renderPast(){
    const wrap = $("past");
    wrap.innerHTML = "";
    pastOptions.forEach(p=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.type = "button";
      b.textContent = p;
      b.onclick = ()=>{
        if(pastSet.has(p)) pastSet.delete(p); else pastSet.add(p);
        b.classList.toggle("on", pastSet.has(p));
        autoSaveDraft();
      };
      wrap.appendChild(b);
    });
  }

  function renderHistory(){
    const hist = loadHistory();
    const box = $("historyList");
    if(!hist.length){
      box.innerHTML = `<div class="muted">履歴はまだありません</div>`;
      return;
    }
    const top10 = hist.slice(0,10);
    box.innerHTML = top10.map(item=>`
      <div class="histItem">
        <div class="histMeta">${item.createdAt}</div>
        <div class="histText">${escapeHtml(item.text)}</div>
        <button class="btn ghost" style="max-width:110px" onclick="deleteHistory('${item.id}')">削除</button>
      </div>
    `).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  window.deleteHistory = function(id){
    const hist = loadHistory().filter(x=>x.id!==id);
    saveHistory(hist);
    renderHistory();
  }

  // -----------------------------
  // Summary generator
  // -----------------------------
  function getField(id){ return ($(id).value || "").trim(); }

  function buildSummary(){
    const patientID = getField("patientID") || "—";
    const age = getField("age") || "—";
    const sex = getField("sex") || "—";

    const lkw = parseDTLocal(getField("lkw"));
    const disc = parseDTLocal(getField("disc"));

    const elapsed = elapsedText(lkw, disc);

    const past = pastSet.size ? Array.from(pastSet).join(" / ") : "—";
    const otherPast = getField("otherPast") || "—";

    const jcs = getField("jcs") || "—";
    const gcsE = getField("gcsE") || "-";
    const gcsV = getField("gcsV") || "-";
    const gcsM = getField("gcsM") || "-";
    const bpSys = getField("bpSys") || "—";
    const bpDia = getField("bpDia") || "—";
    const spo2 = getField("spo2") || "—";
    const oxygenFlow = getField("oxygenFlow") || "—";
    const oxygenPercent = getField("oxygenPercent") || "—";
    const heartRate = getField("heartRate") || "—";
    const heartRhythm = getField("heartRhythm") || "—";
    const irregularSubtype = getField("irregularSubtype");
    const bs = getField("bs") || "—";
    const bt = getField("bt") || "—";
    const pupilRight = getField("pupilRight") || "—";
    const pupilLeft = getField("pupilLeft") || "—";

    const rhythmText = (heartRhythm==="不整" && irregularSubtype) ? `${heartRhythm}, ${irregularSubtype}` : heartRhythm;

    const timeStr = (d)=> d ? formatMDHM(d) : "不明";

    return `脳卒中対応記録

ID: ${patientID}
年齢: ${age}　性別: ${sex}
既往歴: ${past}
その他既往歴: ${otherPast}
最終健在: ${timeStr(lkw)}
発見・発症時刻: ${timeStr(disc)}
経過: ${elapsed}

バイタル:
・JCS: ${jcs} / GCS: E${gcsE} V${gcsV} M${gcsM}
・BP: ${bpSys}/${bpDia} mmHg  SpO₂: ${spo2}%  酸素: ${oxygenFlow}L ${oxygenPercent}%
・HR: ${heartRate}/分 ${rhythmText}
・BS: ${bs} mg/dl  BT: ${bt} ℃
・瞳孔: 右 ${pupilRight} mm / 左 ${pupilLeft} mm
`;
  }

  // -----------------------------
  // Draft autosave
  // -----------------------------
  const draftFields = [
    "patientID","age","sex","lkw","disc",
    "jcs","gcsE","gcsV","gcsM","bpSys","bpDia","spo2",
    "oxygenFlow","oxygenPercent","heartRate","heartRhythm","irregularSubtype","bs","bt","pupilRight","pupilLeft",
    "otherPast"
  ];

  function autoSaveDraft(){
    const obj = {};
    draftFields.forEach(id=> obj[id] = $(id).value );
    obj.past = Array.from(pastSet);
    saveDraft(obj);
  }

  function restoreDraft(){
    const d = loadDraft();
    draftFields.forEach(id=>{
      if(d[id]!==undefined) $(id).value = d[id];
    });
    (d.past||[]).forEach(x=>pastSet.add(x));
    // reflect UI state
    document.querySelectorAll("#past .pill").forEach(btn=>{
      btn.classList.toggle("on", pastSet.has(btn.textContent));
    });
    updateElapsed();
  }

  function updateElapsed(){
    const lkw = parseDTLocal(getField("lkw"));
    const disc = parseDTLocal(getField("disc"));
    $("elapsed").textContent = elapsedText(lkw, disc);
  }

  // -----------------------------
  // Events
  // -----------------------------
  function wireInputs(){
    draftFields.forEach(id=>{
      $(id).addEventListener("input", ()=>{
        updateElapsed();
        autoSaveDraft();
      });
      $(id).addEventListener("change", ()=>{
        updateElapsed();
        autoSaveDraft();
      });
    });

    $("genBtn").onclick = ()=>{
      const txt = buildSummary();
      $("summary").textContent = txt;
    };

    $("copyBtn").onclick = async ()=>{
      const txt = $("summary").textContent.trim();
      if(!txt || txt==="ここに生成されます"){
        $("summary").textContent = buildSummary();
      }
      const finalTxt = $("summary").textContent;
      try{
        await navigator.clipboard.writeText(finalTxt);
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = finalTxt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      // save to history
      const hist = loadHistory();
      hist.unshift({
        id: crypto.randomUUID(),
        createdAt: new Date().toLocaleString("ja-JP"),
        text: finalTxt
      });
      saveHistory(hist);
      renderHistory();
      showToast("保存しました");
    };

    $("clearAllBtn").onclick = ()=>{
      if(!confirm("履歴を全削除しますか？")) return;
      saveHistory([]);
      renderHistory();
      showToast("全削除しました");
    };

    $("heartRhythm").addEventListener("change", ()=>{
      const v = $("heartRhythm").value;
      $("irregularSubtype").disabled = (v !== "不整");
      if(v !== "不整") $("irregularSubtype").value = "";
      autoSaveDraft();
    });
  }

  // -----------------------------
  // Boot
  // -----------------------------
  renderPast();
  wireInputs();
  restoreDraft();
  renderHistory();
  updateElapsed();
  $("irregularSubtype").disabled = ($("heartRhythm").value !== "不整");
</script>
</body>
</html>
